# iDoctor ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
- [æ¶æ„å›¾](#æ¶æ„å›¾)
- [æ¨¡å—è¯´æ˜](#æ¨¡å—è¯´æ˜)
- [ç«¯å£åˆ†é…](#ç«¯å£åˆ†é…)
- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
- [å¯åŠ¨æµç¨‹](#å¯åŠ¨æµç¨‹)

---

## ç³»ç»Ÿæ¦‚è§ˆ

iDoctor ç³»ç»Ÿç”± **3ä¸ªä¸»è¦æ¨¡å—** ç»„æˆï¼š

1. **Commercial å•†ä¸šåŒ–æ¨¡å—** - ç”¨æˆ·è®¤è¯ã€æ”¯ä»˜ã€é…é¢ç®¡ç†
2. **CTAI ä¸»åº”ç”¨æ¨¡å—** - CTå›¾åƒåˆ†æã€SAM2åˆ†å‰²
3. **Nginx åå‘ä»£ç†** - ç»Ÿä¸€å…¥å£ï¼Œè·¯ç”±åˆ†å‘

---

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æµè§ˆå™¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Nginx (ç«¯å£: 3000 å¼€å‘ / 55305 ç”Ÿäº§)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /                 â†’ Commercial Frontend (React)       â”‚ â”‚
â”‚  â”‚  /api/auth         â†’ è®¤è¯æœåŠ¡ (9001)                   â”‚ â”‚
â”‚  â”‚  /api/payment      â†’ æ”¯ä»˜æœåŠ¡ (9002)                   â”‚ â”‚
â”‚  â”‚  /ctai             â†’ CTAI Frontend (Vue)               â”‚ â”‚
â”‚  â”‚  /api/ctai         â†’ CTAI Backend (4200)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚               â”‚             â”‚
       â†“               â†“               â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Commercial  â”‚ â”‚ Commercial   â”‚ â”‚  CTAI    â”‚ â”‚  SAM2      â”‚
â”‚  Frontend   â”‚ â”‚   Backend    â”‚ â”‚ Backend  â”‚ â”‚  Service   â”‚
â”‚  (React)    â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ (FastAPI)â”‚ â”‚ (FastAPI)  â”‚
â”‚             â”‚ â”‚ â”‚Auth API  â”‚ â”‚ â”‚          â”‚ â”‚            â”‚
â”‚  Nginxé™æ€  â”‚ â”‚ â”‚:9001     â”‚ â”‚ â”‚ :4200    â”‚ â”‚ :8000      â”‚
â”‚  æ–‡ä»¶æœåŠ¡   â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚          â”‚ â”‚            â”‚
â”‚             â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚          â”‚ â”‚            â”‚
â”‚             â”‚ â”‚ â”‚Payment   â”‚ â”‚ â”‚          â”‚ â”‚            â”‚
â”‚             â”‚ â”‚ â”‚API :9002 â”‚ â”‚ â”‚          â”‚ â”‚            â”‚
â”‚             â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚          â”‚ â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚              â”‚
                       â†“              â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ PostgreSQL â”‚  â”‚   æ–‡ä»¶ç³»ç»Ÿ â”‚
                â”‚ :5432      â”‚  â”‚ (DICOMç­‰)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¨¡å—è¯´æ˜

### 1. Commercial å•†ä¸šåŒ–æ¨¡å—

**è·¯å¾„**: `commercial/`

#### åŠŸèƒ½
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- é‚®ç®±éªŒè¯ç 
- JWT Tokenç®¡ç†
- æ”¯ä»˜é›†æˆï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰
- é…é¢ç®¡ç†
- è®¢é˜…è®¡åˆ’

#### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: React 18 + Vite
- **åç«¯**: FastAPI (Python 3.10+)
- **æ•°æ®åº“**: PostgreSQL 15
- **å®¹å™¨åŒ–**: Docker Compose

#### å­æœåŠ¡

**è®¤è¯æœåŠ¡ (Auth Service)**
- ç«¯å£: `9001`
- è·¯å¾„: `commercial/auth_service/`
- åŠŸèƒ½: æ³¨å†Œã€ç™»å½•ã€é‚®ç®±éªŒè¯ã€Tokenåˆ·æ–°

**æ”¯ä»˜æœåŠ¡ (Payment Service)**
- ç«¯å£: `9002`
- è·¯å¾„: `commercial/payment_service/`
- åŠŸèƒ½: æ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ã€è®¢å•ç®¡ç†

**æ•°æ®åº“ (PostgreSQL)**
- ç«¯å£: `5432`
- å®¹å™¨å: `idoctor_commercial_db`
- æ•°æ®åº“å: `idoctor_commercial`

**å‰ç«¯ (React)**
- æ„å»ºäº§ç‰©: `commercial/frontend/dist/`
- NginxæœåŠ¡: é™æ€æ–‡ä»¶

---

### 2. CTAI ä¸»åº”ç”¨æ¨¡å—

**è·¯å¾„**: `app.py` (åç«¯) + `CTAI_web/` (å‰ç«¯)

#### åŠŸèƒ½
- DICOMæ–‡ä»¶ä¸Šä¼ 
- CTå›¾åƒåˆ†æ
- L3å±‚è‡ªåŠ¨æ£€æµ‹
- è‚Œè‚‰/è„‚è‚ªåˆ†å‰²
- SAM2æ™ºèƒ½åˆ†å‰²
- æŠ¥å‘Šç”Ÿæˆ

#### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: Vue 2 + Element UI
- **åç«¯**: FastAPI (Python 3.10+)
- **AI**: SAM2 (Segment Anything Model 2)

#### ç«¯å£
- **å‰ç«¯å¼€å‘**: `7500` (å¼€å‘æ¨¡å¼)
- **åç«¯**: `4200` (FastAPI)
- **SAM2**: `8000` (Docker)

#### å…³é”®ç»„ä»¶

**åç«¯ (app.py)**
- æ–‡ä»¶ä¸Šä¼ å¤„ç†
- DICOMè§£æ
- å›¾åƒå¤„ç†
- SAM2é›†æˆ
- è®¤è¯/é…é¢ä¸­é—´ä»¶é›†æˆ

**å‰ç«¯ (CTAI_web)**
- æ‚£è€…ç®¡ç†
- å›¾åƒæŸ¥çœ‹å™¨
- L3 Maskç¼–è¾‘å™¨
- SAM2äº¤äº’åˆ†å‰²

**SAM2æœåŠ¡**
- å®¹å™¨å: `idoctor_sam2_service`
- æ¨¡å‹: SAM2.1 Hiera Large
- åŠŸèƒ½: è‡ªåŠ¨/äº¤äº’å¼å›¾åƒåˆ†å‰²

---

### 3. Nginx åå‘ä»£ç†

**è·¯å¾„**: `commercial/docker/nginx.conf`

#### åŠŸèƒ½
- ç»Ÿä¸€å…¥å£
- è·¯ç”±åˆ†å‘
- é™æ€æ–‡ä»¶æœåŠ¡
- CORSå¤„ç†
- è´Ÿè½½å‡è¡¡

#### è·¯ç”±é…ç½®

| è·¯å¾„ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|
| `/` | Commercial Frontend | Reactåº”ç”¨ |
| `/api/auth` | Auth Service (9001) | è®¤è¯API |
| `/api/payment` | Payment Service (9002) | æ”¯ä»˜API |
| `/ctai` | CTAI Frontend | Vueåº”ç”¨ |
| `/api/ctai` | CTAI Backend (4200) | ä¸»åº”ç”¨API |

---

## ç«¯å£åˆ†é…

### å¼€å‘ç¯å¢ƒ (Macæœ¬åœ°)

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| **Nginx** | `3000` | ç»Ÿä¸€å…¥å£ |
| **CTAI Backend** | `4200` | FastAPI (ç›´æ¥è¿è¡Œ) |
| **CTAI Frontend** | `7500` | Vue Dev Server |
| **SAM2 Service** | `8000` | Docker |
| **Auth Service** | `9001` | Docker |
| **Payment Service** | `9002` | Docker |
| **PostgreSQL** | `5432` | Docker |

### ç”Ÿäº§ç¯å¢ƒ (æœåŠ¡å™¨)

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| **Nginx** | `55305` | ç»Ÿä¸€å…¥å£ |
| **CTAI Backend** | `4200` | FastAPI (å®ˆæŠ¤è¿›ç¨‹) |
| **CTAI Frontend** | - | é™æ€æ–‡ä»¶ (Nginx) |
| **SAM2 Service** | `8000` | Docker (å†…éƒ¨) |
| **Auth Service** | `9001` | Docker (å†…éƒ¨) |
| **Payment Service** | `9002` | Docker (å†…éƒ¨) |
| **PostgreSQL** | `5432` | Docker (å†…éƒ¨) |

---

## ç¯å¢ƒé…ç½®

### é…ç½®æ–‡ä»¶åˆ—è¡¨

```
iDoctor-backend/
â”œâ”€â”€ .env                           # CTAIä¸»åº”ç”¨é…ç½®
â”œâ”€â”€ commercial/
â”‚   â”œâ”€â”€ .env                       # Commercialå…±äº«é…ç½®
â”‚   â””â”€â”€ docker/
â”‚       â”œâ”€â”€ .env.prod              # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”‚       â””â”€â”€ .env.prod.example      # ç”Ÿäº§ç¯å¢ƒæ¨¡æ¿
â””â”€â”€ CTAI_web/
    â”œâ”€â”€ .env.development           # CTAIå‰ç«¯å¼€å‘é…ç½®
    â”œâ”€â”€ .env.local                 # CTAIå‰ç«¯æœ¬åœ°é…ç½®
    â””â”€â”€ .env.production            # CTAIå‰ç«¯ç”Ÿäº§é…ç½®
```

### å…³é”®é…ç½®é¡¹

#### `.env` (CTAIä¸»åº”ç”¨)

```bash
# æ•°æ®åº“
DATABASE_URL=postgresql+asyncpg://postgres:postgres123@localhost:5432/idoctor_commercial

# JWT
JWT_SECRET_KEY=your-secret-key
JWT_ALGORITHM=HS256

# å•†ä¸šåŒ–åŠŸèƒ½
ENABLE_AUTH=true        # å¼€å¯è®¤è¯
ENABLE_QUOTA=true       # å¼€å¯é…é¢

# SAM2
SAM2_SERVICE_URL=http://localhost:8000
SAM2_ENABLED=true
SAM2_REQUEST_TIMEOUT=120

# SMTP
SMTP_HOST=smtp.gmail.com
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
```

#### `commercial/docker/.env.prod` (ç”Ÿäº§ç¯å¢ƒ)

```bash
NGINX_SERVER_NAME=ai.bygpu.com
NGINX_EXTERNAL_PORT=55305
DATABASE_PASSWORD=your-db-password
JWT_SECRET_KEY=your-jwt-secret
```

---

## å¯åŠ¨æµç¨‹

### å¼€å‘ç¯å¢ƒå¯åŠ¨é¡ºåº

1. **å¯åŠ¨ Commercial æ¨¡å—**
   ```bash
   cd commercial
   bash scripts/deploy-all.sh dev
   ```
   - æ„å»ºReactå‰ç«¯
   - å¯åŠ¨PostgreSQL
   - å¯åŠ¨Auth/PaymentæœåŠ¡
   - å¯åŠ¨SAM2æœåŠ¡
   - å¯åŠ¨Nginx

2. **å¯åŠ¨ CTAI åç«¯**
   ```bash
   bash scripts/start-ctai-backend.sh dev
   ```
   - æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
   - åŠ è½½.envé…ç½®
   - å¯åŠ¨FastAPI (--reloadæ¨¡å¼)

3. **å¯åŠ¨ CTAI å‰ç«¯** (å¯é€‰å¼€å‘æ¨¡å¼)
   ```bash
   cd CTAI_web
   npm run serve
   ```
   - å¯åŠ¨Vueå¼€å‘æœåŠ¡å™¨ (7500)
   - æˆ–ç›´æ¥é€šè¿‡Nginxè®¿é—®æ„å»ºåçš„æ–‡ä»¶

### ç”Ÿäº§ç¯å¢ƒå¯åŠ¨é¡ºåº

1. **éƒ¨ç½² Commercial æ¨¡å—**
   ```bash
   cd commercial
   bash scripts/deploy-all.sh prod
   ```

2. **éƒ¨ç½² CTAI åº”ç”¨**
   ```bash
   bash scripts/deploy-ctai.sh prod
   ```
   - æ„å»ºVueå‰ç«¯
   - å¯åŠ¨FastAPI (å®ˆæŠ¤è¿›ç¨‹)
   - å¤åˆ¶å‰ç«¯åˆ°Nginxç›®å½•

### éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
bash scripts/check-services.sh

# æŸ¥çœ‹æ—¥å¿—
bash scripts/view-logs.sh
```

---

## æ•°æ®æµ

### 1. ç”¨æˆ·ç™»å½•æµç¨‹

```
æµè§ˆå™¨ â†’ Nginx (:3000)
       â†’ Auth Service (:9001)
       â†’ PostgreSQL (:5432)
       â†’ è¿”å› JWT Token
```

### 2. CTAIåˆ†ææµç¨‹

```
æµè§ˆå™¨ â†’ Nginx (:3000/api/ctai)
       â†’ CTAI Backend (:4200)
       â†’ è®¤è¯ä¸­é—´ä»¶ (éªŒè¯Token)
       â†’ é…é¢ä¸­é—´ä»¶ (æ£€æŸ¥é…é¢)
       â†’ å¤„ç†DICOMæ–‡ä»¶
       â†’ SAM2 Service (:8000) (åˆ†å‰²)
       â†’ è¿”å›ç»“æœ
```

### 3. SAM2äº¤äº’åˆ†å‰²æµç¨‹

```
Vueå‰ç«¯ â†’ ç”¨æˆ·ç‚¹å‡»å›¾åƒ
        â†’ æ”¶é›†ç‚¹å‡»åæ ‡
        â†’ POST /api/ctai/api/segmentation/sam2
        â†’ CTAI Backend
        â†’ SAM2 Client (æ£€æŸ¥ç¼“å­˜)
        â†’ SAM2 Docker Service
        â†’ è¿”å›maskç»“æœ
        â†’ å‰ç«¯æ˜¾ç¤ºåˆ†å‰²åŒºåŸŸ
```

---

## ä¾èµ–å…³ç³»

### Commercial ä¾èµ–

```
Nginx â†’ React Frontend (é™æ€æ–‡ä»¶)
     â†’ Auth Service â†’ PostgreSQL
     â†’ Payment Service â†’ PostgreSQL
```

### CTAI ä¾èµ–

```
CTAI Backend â†’ SAM2 Service (å¯é€‰)
            â†’ PostgreSQL (é€šè¿‡Commercial)
            â†’ æ–‡ä»¶ç³»ç»Ÿ (DICOMå­˜å‚¨)

CTAI Frontend â†’ CTAI Backend
              â†’ Auth Service (ç™»å½•)
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. 503 Service Unavailable (SAM2)**
- æ£€æŸ¥SAM2å®¹å™¨çŠ¶æ€: `docker ps | grep sam2`
- æŸ¥çœ‹SAM2æ—¥å¿—: `docker logs idoctor_sam2_service`
- é‡å¯CTAIåç«¯: `bash scripts/start-ctai-backend.sh dev`

**2. è®¤è¯å¤±è´¥ 401**
- æ£€æŸ¥.envä¸­ENABLE_AUTHé…ç½®
- æ£€æŸ¥JWT_SECRET_KEYæ˜¯å¦ä¸€è‡´
- æ¸…é™¤æµè§ˆå™¨localStorage

**3. é…é¢è€—å°½ 402**
- æ£€æŸ¥æ•°æ®åº“ä¸­çš„é…é¢è®°å½•
- æŸ¥çœ‹é…é¢æ—¥å¿—: `tail -f app.log | grep quota`

**4. Nginx 404**
- æ£€æŸ¥å‰ç«¯æ˜¯å¦æ„å»º: `ls commercial/frontend/dist`
- æ£€æŸ¥Nginxé…ç½®: `docker exec idoctor_commercial_nginx nginx -t`

---

## ç»´æŠ¤å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker ps

# é‡å¯æ‰€æœ‰æœåŠ¡
cd commercial/docker && docker-compose restart

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose logs -f

# æ¸…ç†æ•°æ®åº“ï¼ˆæ…ç”¨ï¼‰
docker-compose down -v

# é‡æ–°æ„å»º
docker-compose build --no-cache
```

---

## è”ç³»ä¸æ”¯æŒ

- **æ–‡æ¡£**: `/docs`
- **å¯åŠ¨è„šæœ¬**: `/scripts`
- **é—®é¢˜åé¦ˆ**: GitHub Issues
