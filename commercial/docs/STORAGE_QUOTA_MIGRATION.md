# å­˜å‚¨é…é¢è¿ç§»æŒ‡å—ï¼šGB â†’ MB

**æ—¥æœŸ**: 2025-10-18
**ç›®çš„**: å°†å­˜å‚¨é…é¢å•ä½ä» GB æ”¹ä¸º MBï¼Œé»˜è®¤é…é¢ä» 10GB æ”¹ä¸º 100MB

---

## ğŸ“‹ å˜æ›´æ‘˜è¦

### é…é¢å•ä½å˜æ›´

| é…é¢ç±»å‹ | æ—§å•ä½ | æ—§é»˜è®¤å€¼ | æ–°å•ä½ | æ–°é»˜è®¤å€¼ |
|---------|--------|---------|--------|---------|
| `storage_dicom` | GB | 10 | MB | 100 |
| `storage_results` | GB | 5 | MB | 50 |
| `storage_usage` | MB | 10 | MB | 100 |

### ä»£ç å˜æ›´

1. **`storage_tracker.py`** - æ·»åŠ  `bytes_to_mb()` å‡½æ•°ï¼Œæ‰€æœ‰è®¡ç®—æ”¹ä¸º MB
2. **`init_database.py`** - æ–°ç”¨æˆ·é»˜è®¤é…é¢æ”¹ä¸º MB
3. **`app.py`** - ä¸Šä¼ å®Œæˆåè‡ªåŠ¨åŒæ­¥å­˜å‚¨ä½¿ç”¨é‡
4. **é…é¢ä¸­é—´ä»¶** - ä¸å†æ‰£é™¤ä¸Šä¼ é…é¢ï¼ˆä»…åŒæ­¥å®é™…ä½¿ç”¨é‡ï¼‰

---

## ğŸš€ è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1: å¤‡ä»½æ•°æ®åº“

```bash
# PostgreSQL å¤‡ä»½
pg_dump -h localhost -U your_user -d your_database > backup_$(date +%Y%m%d_%H%M%S).sql
```

### æ­¥éª¤ 2: è¿è¡Œè¿ç§»è„šæœ¬

```bash
cd /Users/mbp/Desktop/Work/Life/IDoctor/iDoctor-backend
python commercial/scripts/migrate_storage_to_mb.py
```

è„šæœ¬ä¼šï¼š
1. æ›´æ–° `quota_types` è¡¨ï¼šå•ä½ GB â†’ MBï¼Œé»˜è®¤é™åˆ¶è°ƒæ•´
2. æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„ `quota_limits`ï¼šé™åˆ¶å€¼è°ƒæ•´ï¼Œä½¿ç”¨é‡é‡ç½®ä¸º 0
3. æç¤ºä¸‹ä¸€æ­¥æ“ä½œ

### æ­¥éª¤ 3: åŒæ­¥å®é™…å­˜å‚¨ä½¿ç”¨é‡

```bash
python commercial/scripts/sync_all_users_storage.py
```

æ­¤è„šæœ¬ä¼šï¼š
- éå†æ‰€æœ‰ç”¨æˆ·çš„æ•°æ®ç›®å½•
- è®¡ç®—å®é™…ç£ç›˜ä½¿ç”¨é‡ï¼ˆMBï¼‰
- æ›´æ–°åˆ°æ•°æ®åº“

### æ­¥éª¤ 4: é‡å¯æœåŠ¡

```bash
# åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡
# ç„¶åé‡å¯
uvicorn app:app --host 0.0.0.0 --port 4200 --workers 1
```

### æ­¥éª¤ 5: éªŒè¯

```bash
# æŸ¥çœ‹é…é¢çŠ¶æ€
python check_quota_usage.py
```

åº”è¯¥èƒ½çœ‹åˆ°ï¼š
```
ç”¨æˆ·å             é…é¢ç±»å‹                           é…é¢å                  å•ä½       é™åˆ¶         å·²ç”¨         å‰©ä½™
====================================================================================================
testuser        storage_dicom                  DICOMå­˜å‚¨ç©ºé—´            MB       100.00     12.50      87.50
testuser        storage_results                ç»“æœå­˜å‚¨ç©ºé—´               MB       50.00      8.30       41.70
testuser        storage_usage                  å­˜å‚¨ä½¿ç”¨é‡                MB       100.00     20.80      79.20
```

---

## ğŸ”§ å·¥ä½œåŸç†

### ä¸Šä¼ æµç¨‹

```
ç”¨æˆ·ä¸Šä¼  DICOM ZIP
    â†“
è§£å‹åˆ° data/{user_id}/{patient}_{date}/input/
    â†“
è§¦å‘å­˜å‚¨åŒæ­¥: sync_storage_quota_to_db()
    â†“
è®¡ç®— input/ å’Œ output/ ç›®å½•å¤§å°ï¼ˆMBï¼‰
    â†“
æ›´æ–°æ•°æ®åº“:
  - storage_dicom (input ç›®å½•å¤§å°)
  - storage_results (output ç›®å½•å¤§å°)
  - storage_usage (æ€»å¤§å°)
```

### é…é¢æ£€æŸ¥

**ä¸Šä¼ æ—¶**ï¼šä¸å†æ£€æŸ¥é…é¢ï¼ˆä¹‹å‰æŒ‰ GB æ‰£é™¤å¯¼è‡´å››èˆäº”å…¥é—®é¢˜ï¼‰

**å¤„ç†æ—¶**ï¼šæ£€æŸ¥ `api_calls_full_process` é…é¢ï¼ˆæŒ‰æ¬¡æ•°æ‰£é™¤ï¼‰

**å®šæœŸåŒæ­¥**ï¼šå¯ä»¥å®šæ—¶è¿è¡Œ `sync_all_users_storage.py` æ›´æ–°å®é™…ä½¿ç”¨é‡

---

## ğŸ“Š æ•°æ®åº“ Schema

### quota_types è¡¨

```sql
-- storage_dicom
type_key: 'storage_dicom'
name: 'DICOMå­˜å‚¨ç©ºé—´'
unit: 'MB'
default_limit: 100

-- storage_results
type_key: 'storage_results'
name: 'ç»“æœå­˜å‚¨ç©ºé—´'
unit: 'MB'
default_limit: 50

-- storage_usage
type_key: 'storage_usage'
name: 'å­˜å‚¨ä½¿ç”¨é‡'
unit: 'MB'
default_limit: 100
```

### quota_limits è¡¨

```sql
-- ç¤ºä¾‹ï¼šç”¨æˆ·ä¸Šä¼ äº† 12.5MB çš„ DICOM æ–‡ä»¶ï¼Œå¤„ç†åç”Ÿæˆäº† 8.3MB çš„ç»“æœ
user_id: 'xxx-xxx-xxx'
quota_type_id: <storage_dicom UUID>
limit_amount: 100.00
used_amount: 12.50

user_id: 'xxx-xxx-xxx'
quota_type_id: <storage_results UUID>
limit_amount: 50.00
used_amount: 8.30

user_id: 'xxx-xxx-xxx'
quota_type_id: <storage_usage UUID>
limit_amount: 100.00
used_amount: 20.80  -- 12.5 + 8.3
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯• 1: æ–°ç”¨æˆ·æ³¨å†Œ

1. æ³¨å†Œæ–°ç”¨æˆ·
2. æ£€æŸ¥é…é¢åˆ†é…ï¼š
   ```bash
   python check_quota_usage.py | grep -A 10 "new_user"
   ```
3. **é¢„æœŸ**: `storage_*` é…é¢å•ä½ä¸º MBï¼Œé™åˆ¶ä¸º 100/50/100

### æµ‹è¯• 2: ä¸Šä¼ å¹¶åŒæ­¥

1. ä¸Šä¼ ä¸€ä¸ª 15MB çš„ DICOM ZIP
2. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   INFO: User xxx storage: DICOM=15.23MB, Results=0.00MB, Total=15.23MB, Cases=1
   ```
3. æŸ¥çœ‹é…é¢ï¼š
   ```bash
   python check_quota_usage.py
   ```
4. **é¢„æœŸ**: `storage_dicom` å’Œ `storage_usage` ä½¿ç”¨é‡çº¦ 15MB

### æµ‹è¯• 3: å¤„ç†ååŒæ­¥

1. å¤„ç†ä¸Šä¼ çš„æ•°æ®
2. å¤„ç†å®Œæˆåï¼Œå†æ¬¡æ£€æŸ¥é…é¢
3. **é¢„æœŸ**: `storage_results` å’Œ `storage_usage` å¢åŠ 

### æµ‹è¯• 4: é…é¢è€—å°½

1. æ‰‹åŠ¨å°†ç”¨æˆ·çš„ `storage_usage` é™åˆ¶è®¾ä¸º 20MB
2. å°è¯•ä¸Šä¼  25MB çš„æ–‡ä»¶
3. **é¢„æœŸ**: ä¸Šä¼ æˆåŠŸï¼ˆä¸å†æ£€æŸ¥ï¼‰ï¼Œä½†ä¸‹æ¬¡åŒæ­¥æ—¶ä¼šè¶…é¢

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸å†åœ¨ä¸Šä¼ æ—¶æ£€æŸ¥å­˜å‚¨é…é¢

**åŸå› **ï¼š
- å°æ–‡ä»¶ï¼ˆ<10MBï¼‰è½¬æ¢ä¸º GB åè¢«å››èˆäº”å…¥ä¸º 0.00
- å¯¼è‡´é…é¢æ‰£é™¤ä¸å‡†ç¡®

**æ–°ç­–ç•¥**ï¼š
- ä¸Šä¼ æ—¶åªè®°å½•å®é™…ä½¿ç”¨é‡ï¼ˆä¸æ‰£é™¤é…é¢ï¼‰
- ç®¡ç†å‘˜å¯ä»¥é€šè¿‡æŸ¥çœ‹ `used_amount` ç›‘æ§ç”¨æˆ·ä½¿ç”¨æƒ…å†µ
- å¦‚æœç”¨æˆ·è¶…é¢ï¼Œç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨é™åˆ¶æˆ–æç¤ºå‡çº§

### 2. å®šæœŸåŒæ­¥

å»ºè®®è®¾ç½® cron ä»»åŠ¡å®šæœŸåŒæ­¥ï¼š

```bash
# æ¯å¤©å‡Œæ™¨ 2 ç‚¹åŒæ­¥æ‰€æœ‰ç”¨æˆ·å­˜å‚¨ä½¿ç”¨é‡
0 2 * * * cd /path/to/iDoctor-backend && python commercial/scripts/sync_all_users_storage.py >> /var/log/storage_sync.log 2>&1
```

### 3. æ¸…ç†æ—§æ•°æ®

å¦‚æœç”¨æˆ·åˆ é™¤äº†æ–‡ä»¶ï¼Œéœ€è¦é‡æ–°åŒæ­¥æ‰èƒ½é‡Šæ”¾é…é¢ï¼š

```bash
python commercial/scripts/sync_all_users_storage.py
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šåˆ° GB å•ä½ï¼š

1. æ¢å¤æ•°æ®åº“å¤‡ä»½
2. å›é€€ä»£ç åˆ°è¿ç§»å‰çš„ commit
3. é‡å¯æœåŠ¡

---

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: å­˜å‚¨ä½¿ç”¨é‡æ˜¾ç¤º 0

**åŸå› **: æœªè¿è¡ŒåŒæ­¥è„šæœ¬

**è§£å†³**:
```bash
python commercial/scripts/sync_all_users_storage.py
```

### é—®é¢˜ 2: ç”¨æˆ·æ•°æ®ç›®å½•ä¸å­˜åœ¨

**åŸå› **: ç”¨æˆ·è¿˜æ²¡æœ‰ä¸Šä¼ è¿‡æ•°æ®

**è§£å†³**: æ­£å¸¸ç°è±¡ï¼Œç­‰å¾…ç”¨æˆ·é¦–æ¬¡ä¸Šä¼ åä¼šè‡ªåŠ¨åˆ›å»º

### é—®é¢˜ 3: æƒé™é”™è¯¯

**åŸå› **: è„šæœ¬æ— æ³•è¯»å– data/ ç›®å½•

**è§£å†³**:
```bash
chmod -R 755 data/
```

---

**å®Œæˆæ—¶é—´**: çº¦ 5-10 åˆ†é’Ÿï¼ˆå–å†³äºç”¨æˆ·æ•°é‡å’Œæ•°æ®é‡ï¼‰
